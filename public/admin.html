<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Panel</title>
  <link rel="icon" href="favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; margin: 0; padding: 20px; background: #1e1e1e; color: #fff; }
    .card { background:#2d2d30; border:1px solid #444; border-radius:8px; padding:16px; max-width:720px; margin:0 auto; }
    .row { margin: 12px 0; }
    input[type=email], input[type=text] { width:100%; padding:10px; border-radius:6px; border:1px solid #555; background:#3c3c3c; color:#fff; }
    button { background:#0e639c; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; }
    button:disabled { background:#555; cursor:not-allowed; }
    .sliders { display:flex; gap:20px; margin-top:12px; }
    .slider { flex:1; background:#3c3c3c; padding:12px; border-radius:8px; border:1px solid #555; }
    .switch { position: relative; display: inline-block; width: 52px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider-toggle { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #777; transition: .2s; border-radius: 28px; }
    .slider-toggle:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider-toggle { background-color: #2196F3; }
    input:checked + .slider-toggle:before { transform: translateX(24px); }
    .hidden { display:none; }
    .error { color:#ff6b6b; }
    .ok { color:#6cbf6c; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Tenant Admin Panel: <strong id="currentTenant">Loading...</strong></h2>
    <div class="row">
      <button id="backBtn" onclick="goBack()">‚Üê Back to Blockbuilder</button>
    </div>
    <div id="status" class="row">Checking permissions...</div>
    <div class="row">
      <label>Email</label>
      <input id="email" type="email" placeholder="user@example.com" />
    </div>
    <div class="row">
      <button id="loadBtn">Load</button>
    </div>
    <div id="controls" class="row">
      <div class="sliders">
        <div class="slider"><div>Read</div><label class="switch"><input id="readToggle" type="checkbox"><span class="slider-toggle"></span></label></div>
        <div class="slider"><div>Write</div><label class="switch"><input id="writeToggle" type="checkbox"><span class="slider-toggle"></span></label></div>
        <div class="slider"><div>Admin</div><label class="switch"><input id="adminToggle" type="checkbox"><span class="slider-toggle"></span></label></div>
      </div>
      <div class="row" style="margin-top:16px"><button id="saveBtn">Save</button></div>
      <div id="saveStatus" class="row"></div>
    </div>
  </div>

  <!-- API Configuration -->
  <script type="text/javascript" src="api-config.js"></script>
  
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let tenant = urlParams.get('tenant');
    
    // If no tenant in URL, default to stored tenant from localStorage
    if (!tenant) {
      tenant = localStorage.getItem('last_tenant') || 'default';
      console.log('No tenant in URL, using stored tenant:', tenant);
    }
    
    // Update the current tenant display immediately
    document.getElementById('currentTenant').textContent = tenant;
    // Call API Gateway cross-origin directly
    const API_ROOT = (window.GOOGLE_OAUTH_CONFIG && (window.GOOGLE_OAUTH_CONFIG.API_ROOT || window.GOOGLE_OAUTH_CONFIG.API_BASE_URL))
      || window.API_CONFIG.API_BASE_URL;

    function getStoredToken() {
      try {
        const stored = localStorage.getItem('google_access_token');
        if (!stored) return null;
        let payload = null; try { payload = JSON.parse(stored); } catch(e) {}
        const token = (payload && payload.token) ? payload.token : stored;
        const notExpired = !payload || !payload.expiresAt || Date.now() < payload.expiresAt;
        return notExpired ? token : null;
      } catch(e) { return null; }
    }

    async function checkAdmin() {
      const token = getStoredToken();
      if (!tenant) { document.getElementById('status').innerHTML = '<span class="error">Missing tenant</span>'; return false; }
      if (!token) { document.getElementById('status').innerHTML = '<span class="error">Not authenticated</span>'; return false; }
      try {
        const body = {
          type: 'auth',
          body: { extension: tenant, google_access_token: token, scope: 'read' }
        };
        const res = await fetch(API_ROOT + '/auth', { method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        let data = await res.json();
        if (data && typeof data.body === 'string') { try { data = JSON.parse(data.body); } catch(_){} }
        const isAdmin = (data && data.permissions && data.permissions.admin);
        if (isAdmin) {
          document.getElementById('status').innerHTML = '<span class="ok">Admin access granted</span>';
          return true;
        }
      } catch(e) { /* noop */ }
      document.getElementById('status').innerHTML = '<span class="error">Admin access required</span>';
      return false;
    }

    async function loadUser() {
      const email = document.getElementById('email').value.trim();
      const token = getStoredToken();
      if (!email) return;
      document.getElementById('saveStatus').textContent = '';
      try {
        // Query by email via manage endpoint with action=get (reuse path)
        const body = {
          type: 'manage_oauth_scopes',
          body: { extension: tenant, user_email: email, action: 'get' }
        };
        const res = await fetch(API_ROOT + '/manage_oauth_scopes', { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(body) });
        const json = await res.json();
        let data = json;
        if (data && typeof data.body === 'string') { try { data = JSON.parse(data.body); } catch(_){} }
        const scopes = (data && data.scopes) || [];
        document.getElementById('readToggle').checked = scopes.includes('read');
        document.getElementById('writeToggle').checked = scopes.includes('write');
        document.getElementById('adminToggle').checked = scopes.includes('admin');
        // Controls are now always visible
      } catch(e) { document.getElementById('saveStatus').textContent = 'Failed to load user'; }
    }

    async function saveUser() {
      const email = document.getElementById('email').value.trim();
      const token = getStoredToken();
      const scopes = [];
      if (document.getElementById('readToggle').checked) scopes.push('read');
      if (document.getElementById('writeToggle').checked) scopes.push('write');
      if (document.getElementById('adminToggle').checked) scopes.push('admin');
      try {
        const body = {
          type: 'manage_oauth_scopes',
          body: { extension: tenant, user_email: email, scopes: scopes, action: 'set' }
        };
        const res = await fetch(API_ROOT + '/manage_oauth_scopes', { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(body) });
        if (!res.ok) throw new Error('save failed');
        document.getElementById('saveStatus').innerHTML = '<span class="ok">Saved!</span>';
      } catch(e) { document.getElementById('saveStatus').innerHTML = '<span class="error">Save failed</span>'; }
    }

    function goBack() {
      // Navigate back to main page with tenant context preserved
      const currentUrl = new URL(window.location);
      const tenant = currentUrl.searchParams.get('tenant');
      const mainUrl = tenant ? `/?tenant=${encodeURIComponent(tenant)}` : '/';
      window.location.href = mainUrl;
    }

    // Add hierarchical permission logic
    function updatePermissionHierarchy(event) {
      const toggles = [
        document.getElementById('readToggle'),   // index 0
        document.getElementById('writeToggle'),  // index 1
        document.getElementById('adminToggle')   // index 2
      ];
      
      const clickedToggle = event.target;
      const clickedIndex = toggles.indexOf(clickedToggle);
      
      if (clickedToggle.checked) {
        // Permission gained: Set all lower level permissions True
        for (let i = 0; i < clickedIndex; i++) {
          toggles[i].checked = true;
        }
      } else {
        // Permission lost: Set all higher level permissions False
        for (let i = clickedIndex + 1; i < toggles.length; i++) {
          toggles[i].checked = false;
        }
      }
    }

    // Add event listeners for hierarchical permissions
    document.getElementById('readToggle').addEventListener('change', updatePermissionHierarchy);
    document.getElementById('writeToggle').addEventListener('change', updatePermissionHierarchy);
    document.getElementById('adminToggle').addEventListener('change', updatePermissionHierarchy);

    document.getElementById('loadBtn').addEventListener('click', loadUser);
    document.getElementById('saveBtn').addEventListener('click', saveUser);

    (async () => { if (await checkAdmin()) { /* ready */ } })();
  </script>
</body>
</html>

