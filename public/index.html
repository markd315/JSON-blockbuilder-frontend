<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>A Blockly-based visual editor for JSON structures.</title>

    <!-- AJV for schema validation -->
    <script type="text/javascript" src="https://unpkg.com/ajv@8.5.0/dist/ajv.min.js"></script>
    
    <!-- Modern Blockly imports -->
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/blockly_compressed.js"></script>
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/javascript_compressed.js"></script>
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/blocks_compressed.js"></script>
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/msg/en.js"></script>
    
    <!-- Blockly themes -->
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/themes.js"></script>

    <!-- Custom field and extensions -->
    <script type="text/javascript" src="button-field.js"></script>

    <!-- Core Blockly extensions and primitive blocks -->
    <script type="text/javascript" src="block-extensions.js"></script>
    <script type="text/javascript" src="block-definitions.js"></script>
    <script type="text/javascript" src="json-workspace-converter.js"></script>

    <!-- Dynamic block loading from S3, and generates JSON for all object types-->
    <script type="text/javascript" src="schema-loader.js"></script>

    <!-- Keyboard navigation -->
    <script type="text/javascript" src="keyboard-navigation.js"></script>

    <!-- Google OAuth Configuration -->
    <script type="text/javascript" src="oauth-config.js"></script>
    
    <!-- CRITICAL: Block ALL network requests and initialization before anything loads -->
    <script type="text/javascript">
        // IMMEDIATE blocking - hide page before DOM loads
        document.write('<style>body { visibility: hidden !important; }</style>');
        
        // Block all initialization
        window.pageBlocked = true;
        window.authCheckInProgress = true;
        window.SECURITY_BLOCK_ALL_REQUESTS = true;
    
        // Override fetch globally to block ALL network requests except auth-related ones
        window.originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (window.SECURITY_BLOCK_ALL_REQUESTS) {
                const url = args[0];
                // If a stored token exists and is not expired, lift the block immediately
                try {
                    const stored = localStorage.getItem('google_access_token');
                    if (stored) {
                        let tokenPayload = null;
                        try { tokenPayload = JSON.parse(stored); } catch (_) {}
                        const token = (tokenPayload && tokenPayload.token) ? tokenPayload.token : stored;
                        const notExpired = !tokenPayload || !tokenPayload.expiresAt || Date.now() < tokenPayload.expiresAt;
                        if (token && notExpired) {
                            console.log('âœ… SECURITY: Stored auth token detected - lifting block for requests');
                            window.SECURITY_BLOCK_ALL_REQUESTS = false;
                            return window.originalFetch(...args);
                        }
                    }
                } catch (_) { /* noop */ }
                // Allow only authentication-related requests and essential app requests
                const isAuthRequest = url.includes('/tenant-properties') || 
                                     url.includes('/schemas') ||
                                     url.includes('/api/auth') ||
                                     url.includes('/api/manage_oauth_scopes') ||
                                     url.includes('/api/oauth_token_exchange') ||
                                     url.includes('accounts.google.com') || 
                                     url.includes('googleapis.com/oauth2') ||
                                     url.includes('www.googleapis.com/oauth2') ||
                                     url.includes('execute-api.us-east-1.amazonaws.com/dev/api');
                
                if (!isAuthRequest) {
                    console.log('ðŸš« SECURITY: Network request blocked - authentication required', url);
                    return Promise.reject(new Error('Network requests blocked - authentication required'));
                } else {
                    console.log('âœ… SECURITY: Auth-related request allowed', url);
                }
            }
            return window.originalFetch(...args);
        };
        
        // Override XMLHttpRequest to block legacy requests
        const OriginalXMLHttpRequest = window.XMLHttpRequest;
        window.XMLHttpRequest = function() {
            const xhr = new OriginalXMLHttpRequest();
            const originalOpen = xhr.open;
            xhr.open = function(...args) {
                if (window.SECURITY_BLOCK_ALL_REQUESTS) {
                    console.log('ðŸš« SECURITY: XMLHttpRequest blocked - authentication required', args[1]);
                    throw new Error('XMLHttpRequest blocked - authentication required');
                }
                return originalOpen.apply(this, args);
            };
            return xhr;
        };
        
        // Override any initialization functions immediately
        window.initializeApp = function() {
            console.log('ðŸš« App initialization blocked - authentication required');
            return false;
        };
        
        window.loadSchema = function() {
            console.log('ðŸš« Schema loading blocked - authentication required');
            return false;
        };
        
        // Block common schema loading functions
        window.loadSchemaFromServer = function() {
            console.log('ðŸš« Schema server loading blocked - authentication required');
            return Promise.reject(new Error('Schema loading blocked - authentication required'));
        };
    </script>
    
    <!-- Google OAuth Authentication -->
    <script type="text/javascript" src="google-oauth-auth.js"></script>

    <!-- Validation module -->
    <script type="text/javascript" src="validations.js"></script>
    
    <!-- Main application logic (bundle.js contains main.js functions) -->
    <script type="text/javascript" src="bundle.js"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #ffffff;
            --blockly-bg: #1e1e1e;
            --controls-bg: #2d2d30;
            --border-color: #444;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }
        
        h1 {
            font-weight: normal;
            font-size: 140%;
            padding-left: 500px;
            color: #ffffff;
        }
        
        .theme-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .theme-selector label {
            color: #ffffff;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .theme-selector select {
            background: #333;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .theme-selector select:focus {
            outline: none;
            border-color: #007acc;
        }

        /* Authentication UI Styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .auth-card {
            background-color: var(--controls-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .auth-card h2 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .auth-card p {
            color: var(--text-color);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .error-message {
            color: #ff6b6b !important;
            font-weight: bold;
        }

        .auth-button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 8px;
        }

        .auth-button:hover {
            background-color: #3367d6;
        }

        .auth-button:focus {
            outline: 2px solid #0078d4;
            outline-offset: 2px;
        }
        
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: row;
        }
        
        .blockly-container {
            flex: 0 0 70%;
            height: 100vh;
            background: var(--blockly-bg);
            position: relative;
        }
        
        .controls-panel {
            flex: 0 0 30%;
            height: 100vh;
            background: var(--controls-bg);
            border-left: 1px solid var(--border-color);
            padding: 15px;
            color: var(--text-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .control-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-row label {
            color: #cccccc;
            font-size: 12px;
            font-weight: 600;
            margin: 0;
        }
        
        .http-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        
        .http-methods button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 0 0 auto;
        }
        
        .http-methods button:hover {
            background: #1177bb;
        }
        
        .http-methods button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .http-methods input {
            background: #3c3c3c;
            color: #ffffff;
            border: 1px solid #555;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            flex: 1;
            min-width: 100px;
        }
        
        .control-row textarea {
            background: #1e1e1e;
            color: #ffffff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            resize: vertical;
            width: 100%;
            min-height: 60px;
        }
        
        .control-row textarea:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .action-buttons button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 1;
        }
        
        .action-buttons button:hover {
            background: #1177bb;
        }
        
        .primary-button {
            background: #0e639c !important;
        }
        
        .primary-button:hover {
            background: #1177bb !important;
        }
        
        .secondary-button {
            background: #6c757d !important;
        }
        
        .secondary-button:hover {
            background: #5a6268 !important;
        }
        
        .ai-tools-link {
            display: inline-block;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .ai-tools-link:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            text-decoration: none;
            color: white;
        }
        
        /* Collapsible sections */
        .collapsible-section {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--controls-bg);
        }
        
        .collapsible-header {
            padding: 10px 15px;
            background: #3c3c3c;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px 4px 0 0;
        }
        
        .collapsible-header:hover {
            background: #4c4c4c;
        }
        
        .collapsible-header h4 {
            margin: 0;
            font-size: 12px;
            font-weight: 600;
            color: #cccccc;
        }
        
        .collapsible-toggle {
            font-size: 14px;
            color: #888;
            transition: transform 0.2s ease;
        }
        
        .collapsible-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            padding: 15px;
            display: none;
        }
        
        .collapsible-content.expanded {
            display: block;
        }
        
        .kv-pair {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .kv-pair input {
            background: #3c3c3c;
            color: #ffffff;
            border: 1px solid #555;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            flex: 1;
        }
        
        .kv-pair input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .kv-pair button {
            background: #e22;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 0 0 auto;
        }
        
        .kv-pair button:hover {
            background: #c11;
        }
        
        .add-kv-button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 8px;
        }
        
        .add-kv-button:hover {
            background: #1177bb;
        }
        
        /* Count indicators */
        .count-indicator {
            font-size: 11px;
            font-weight: normal;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #555;
            color: #fff;
            transition: all 0.2s ease;
        }
        
        .count-indicator.complete {
            background: #0e639c;
            color: #fff;
        }
        
        .count-indicator.incomplete {
            background: #e22;
            color: #fff;
        }
        
        /* Blockly workspace dark theme overrides */
        .blocklyMainBackground {
            fill: #1e1e1e !important;
        }
        
        .blocklyToolboxDiv {
            background-color: #2d2d30 !important;
            border-right: 1px solid #444 !important;
        }
        
        .blocklyFlyout {
            background-color: #2d2d30 !important;
        }
        
        .blocklyScrollbarHandle {
            fill: #555 !important;
        }
        
        .blocklyScrollbarBackground {
            fill: #333 !important;
        }
        
        /* Classic theme - white canvas */
        .classic-theme .blocklySvgGroup {
            background-color: #ffffff !important;
        }
        
        .classic-theme .blocklyMainBackground {
            fill: #ffffff !important;
        }
        
        .classic-theme .blocklyWorkspaceBackground {
            fill: #ffffff !important;
        }
    </style>
</head>
<body>

<!--<h1>Built complex rules authomatically by <a href=http://jsonlogic.com/>JsonLogic editor</a> utilizing <a href="https://developers.google.com/blockly/">Blockly</a></h1>-->

  <div class="main-container">
    <div class="blockly-container">
      <div class="theme-selector">
        <label for="themeSelect">Theme:</label>
        <select id="themeSelect" onchange="changeTheme()">
          <option value="dark">Dark (Default)</option>
          <option value="classic">Classic</option>
          <option value="modern">Modern</option>
          <option value="colorblind-wong">Colorblind (Wong)</option>
          <option value="colorblind-tol">Colorblind (Tol)</option>
        </select>
      </div>
      <div id="blocklyDiv" style="width: 100%; height: 100%"></div>

    <xml id="toolbox" style="display: none">

        <category name="Dynamic Types" categorystyle="dynamic_category">
            <block type="dictionary" style="dynamic_blocks"></block>
            <block type="dynarray" style="dynamic_blocks"></block>
        </category>
       
        <category name="Primitives" categorystyle="primitive_category">
            <block type="start" style="start_blocks"></block>
            <block type="string" style="string_blocks"></block>
            <block type="string_array" style="string_blocks"></block>
            <block type="string_password" style="string_blocks"></block>
            <block type="string_email" style="string_blocks"></block>
            <block type="string_enum" style="string_blocks"></block>
            <block type="number" style="number_blocks"></block>
            <block type="number_array" style="number_blocks"></block>
            <block type="boolean" style="boolean_blocks"></block>
            <block type="boolean_array" style="boolean_blocks"></block>
            <block type="variable" style="primitive_blocks"></block>
        </category>

        <!-- Custom Objects category will be populated dynamically based on tenant schemas -->
        <category name="Custom Objects" categorystyle="custom_category" id="custom-objects">
            <!-- Blocks will be added here dynamically -->
        </category>

        <!-- Custom Arrays category will be populated dynamically based on tenant schemas -->
        <category name="Custom Lists" categorystyle="custom_category" id="custom-arrays">
            <!-- Array blocks will be added here dynamically -->
        </category>
        <!---->

        <!-- Custom Arrays category will be populated dynamically based on tenant schemas -->
        <category name="Custom Dictionaries" categorystyle="custom_category" id="custom-dicts">
            <!-- Array blocks will be added here dynamically -->
        </category>
        <!---->
        

    </xml>
    </div>

    <div class="controls-panel">
        <!-- Row 1: HTTP Methods -->
        <div class="control-row">
            <label>HTTP Methods</label>
            <div class="http-methods">
                <button id="post" onclick='sendRequests("POST")'>POST</button>
                <input id="path_id" placeholder="existing element id here" oninput="handlePathIdChange()"></input>
                <button id="put" disabled onclick='sendRequests("PUT")'>PUT</button>
                <button id="patch" disabled onclick='sendRequests("PATCH")'>PATCH</button>
                <button id="get" onclick='sendRequests("GET")'>GET</button>
                <button id="delete" disabled onclick='sendRequests("DELETE")'>DELETE</button>
            </div>
        </div>
        
        <!-- Row 2: Route -->
        <div class="control-row">
            <label>API Route</label>
            <div style="display: flex; gap: 8px; align-items: flex-start;">
                <textarea id="full_route" placeholder="API endpoint URL" style="height: 40px; flex: 1;"></textarea>
                <select id="endpoint_selector" style="background: #3c3c3c; color: #ffffff; border: 1px solid #555; border-radius: 4px; padding: 6px 8px; font-size: 11px; min-width: 120px; height: 40px;" onchange="handleEndpointChange()">
                    <option value="">Select Endpoint</option>
                </select>
            </div>
        </div>
        
        <!-- Row 3: Current JSON -->
        <div class="control-row">
            <label>Current JSON</label>
            <textarea id="json_area" placeholder="JSON payload" style="height: 180px;"></textarea>
        </div>
        
        <!-- Row 4: Response -->
        <div class="control-row">
            <label>Validations+Responses</label>
            <textarea id="response_area" placeholder="API response" style="height: 120px;"></textarea>
        </div>
        
        <!-- Row 5: Actions -->
        <div class="control-row">
            <label>Actions</label>
            <div class="action-buttons">
                <button id="reverse" onclick='loadFromJson()' class="primary-button">Rebuild from JSON</button>
                <button id="load_disk" onclick='relaxStaticTyping()' class="secondary-button">Relax Static Typing</button>
            </div>
            <div style="margin-top: 8px; margin-left: 8px;">
                <label style="font-size: 10px; color: #aaa;">Root Schema Type (optional):</label>
                <input id="root_schema_type" placeholder="dictionary" style="width: 200px; margin-top: 4px; padding: 4px; background: #3c3c3c; color: #ffffff; border: 1px solid #555; border-radius: 4px; font-size: 11px;" />
                <div style="font-size: 9px; color: #888; margin-top: 2px;">This will set the type of the root object when rebuilding from JSON</div>
            </div>
            <a href="#" id="aiToolsLink" class="ai-tools-link">ðŸ¤– AI Tools</a>
            <a href="#" id="adminPanelLink" class="ai-tools-link" style="display: none; margin-left: 8px; background: linear-gradient(135deg, #9C27B0, #673AB7);">ðŸ›  Admin Panel</a>
        </div>
        
        <!-- Query Parameters Section -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('query-params')">
                <h4>Query Parameters <span id="query-params-count" class="count-indicator">(0)</span></h4>
                <span class="collapsible-toggle" id="query-params-toggle">â–¶</span>
            </div>
            <div class="collapsible-content" id="query-params-content">
                <div id="query-params-list">
                    <!-- Query parameter pairs will be added here -->
                </div>
                <button class="add-kv-button" onclick="addQueryParam()">+ Add Query Parameter</button>
            </div>
        </div>
        
        <!-- Headers Section -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('headers')">
                <h4>Headers <span id="headers-count" class="count-indicator">(0)</span></h4>
                <span class="collapsible-toggle" id="headers-toggle">â–¶</span>
            </div>
            <div class="collapsible-content" id="headers-content">
                <div id="headers-list">
                    <!-- Header pairs will be added here -->
                </div>
                <button class="add-kv-button" onclick="addHeader()">+ Add Header</button>
            </div>
        </div>
        
        <!-- Variables Section -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('variables')">
                <h4>Variables <span id="variables-count" class="count-indicator">(0)</span></h4>
                <span class="collapsible-toggle" id="variables-toggle">â–¶</span>
            </div>
            <div class="collapsible-content" id="variables-content">
                <div id="variables-list">
                    <!-- Variable pairs will be added here -->
                </div>
                <button class="add-kv-button" onclick="addVariable()">+ Add Variable</button>
            </div>
        </div>
    </div>
  </div>

  <script>
    // Preserve tenant parameter in AI tools link
    const urlParams = new URLSearchParams(window.location.search);
    const tenant = urlParams.get('tenant');
    if (tenant) {
      document.getElementById('aiToolsLink').href = `llm-tools.html?tenant=${encodeURIComponent(tenant)}`;
    } else {
      document.getElementById('aiToolsLink').href = 'llm-tools.html?tenant=meta';
    }
    // Admin panel link
    const adminLink = document.getElementById('adminPanelLink');
    if (adminLink) {
      adminLink.href = tenant ? `admin.html?tenant=${encodeURIComponent(tenant)}` : 'admin.html?tenant=meta';
    }
    
    // Theme management
    let currentWorkspace = null;
    
    // Make currentWorkspace globally available
    window.currentWorkspace = null;
    
    // Clear one-time reload guard; reveal admin link if admin stored in session
    try {
      window.addEventListener('load', () => {
        localStorage.removeItem('auth_reloaded_once');
        try {
          const perms = sessionStorage.getItem('user_permissions');
          if (perms) {
            const parsed = JSON.parse(perms);
            if (parsed && parsed.admin) {
              const link = document.getElementById('adminPanelLink');
              if (link) link.style.display = '';
            }
          }
        } catch (_) {}
        
        // Deserialize headers, query params, and variables from URL
        if (typeof deserializeFromUrl === 'function') {
          deserializeFromUrl();
        }
        
        // Initialize count indicators
        setTimeout(() => {
          if (typeof updateQueryParamsCount === 'function') updateQueryParamsCount();
          if (typeof updateHeadersCount === 'function') updateHeadersCount();
          if (typeof updateVariablesCount === 'function') updateVariablesCount();
        }, 100);
      });
    } catch (e) {}
    
    // Define custom themes with proper block and category styles
    const customThemes = {
      'dark': Blockly.Theme.defineTheme('dark', {
        'base': Blockly.Themes.Dark,
        'blockStyles': {
          'start_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'primitive_blocks': {
            'colourPrimary': '#01579b',
            'colourSecondary': '#64C7FF',
            'colourTertiary': '#C5EAFF'
          },
          'dynamic_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'custom_blocks': {
            'colourPrimary': '#2e7d32',
            'colourSecondary': '#81c784',
            'colourTertiary': '#c8e6c9'
          }
        },
        'categoryStyles': {
          'start_category': {
            'colour': '#4a148c'
          },
          'primitive_category': {
            'colour': '#01579b'
          },
          'dynamic_category': {
            'colour': '#4a148c'
          },
          'custom_category': {
            'colour': '#2e7d32'
          }
        }
      }),
      'classic': Blockly.Theme.defineTheme('classic', {
        'base': Blockly.Themes.Classic,
        'componentStyles': {
          'workspaceBackgroundColour': '#ffffff'
        }
      }),
      'modern': Blockly.Theme.defineTheme('modern', {
        'base': Blockly.Themes.Modern,
        'blockStyles': {
          'start_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'primitive_blocks': {
            'colourPrimary': '#01579b',
            'colourSecondary': '#64C7FF',
            'colourTertiary': '#C5EAFF'
          },
          'dynamic_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'custom_blocks': {
            'colourPrimary': '#2e7d32',
            'colourSecondary': '#81c784',
            'colourTertiary': '#c8e6c9'
          }
        },
        'categoryStyles': {
          'start_category': {
            'colour': '#4a148c'
          },
          'primitive_category': {
            'colour': '#01579b'
          },
          'dynamic_category': {
            'colour': '#4a148c'
          },
          'custom_category': {
            'colour': '#2e7d32'
          }
        }
      }),
      'colorblind-wong': Blockly.Theme.defineTheme('colorblind-wong', {
        'base': Blockly.Themes.Classic
      }),
      'colorblind-tol': Blockly.Theme.defineTheme('colorblind-tol', {
        'base': Blockly.Themes.Classic
      })
    };
    
    // Available themes
    const themes = customThemes;
    
    // Make themes available globally for schema-loader.js
    window.themes = themes;
    
    // Function to restore original block colors from schemas
    function restoreOriginalColors(workspace) {
      if (!workspace) return;
      
      console.log('=== RESTORING ORIGINAL COLORS ===');
      
      // Get the FULL schema library with colors from S3BlockLoader
      let schemaLibrary = {};
      if (window.currentS3BlockLoader && window.currentS3BlockLoader.schemaLibrary) {
        schemaLibrary = window.currentS3BlockLoader.schemaLibrary;
        console.log('FULL schema library loaded with colors:', Object.keys(schemaLibrary));
        console.log('Sample schema with color:', schemaLibrary[Object.keys(schemaLibrary)[0]]);
      } else {
        console.error('S3BlockLoader schemaLibrary not available!');
        return;
      }
      
      // Apply to workspace blocks
      const allBlocks = workspace.getAllBlocks();
      console.log(`Found ${allBlocks.length} workspace blocks`);
      allBlocks.forEach(block => {
        try {
          // Determine the base block name (remove _array, _dict suffixes)
          let baseBlockName = block.type;
          if (baseBlockName.endsWith('_array') || baseBlockName.endsWith('_dict')) {
            baseBlockName = baseBlockName.replace(/_array$|_dict$/, '');
          }
          
          // Look up the original color from the schema
          if (schemaLibrary[baseBlockName] && schemaLibrary[baseBlockName].color !== undefined) {
            const originalColor = schemaLibrary[baseBlockName].color;
            block.setColour(originalColor);
            console.log(`âœ“ Restored workspace block ${block.type} (${baseBlockName}) to color ${originalColor}`);
          } else {
            // Fallback to default colors for primitive blocks
            const defaultColors = {
              'start': 250,
              'dictionary': 120,
              'dynarray': 120,
              'boolean': 155,
              'boolean_array': 155,
              'string': 190,
              'string_password': 190,
              'string_email': 190,
              'string_enum': 190,
              'string_array': 190,
              'number': 210,
              'number_array': 210
            };
            
            if (defaultColors[block.type]) {
              block.setColour(defaultColors[block.type]);
              console.log(`âœ“ Restored workspace block ${block.type} to default color ${defaultColors[block.type]}`);
            } else {
              console.warn(`âš  No color found for workspace block ${block.type} (${baseBlockName})`);
            }
          }
        } catch (e) {
          console.warn(`Failed to restore color for workspace block ${block.type}:`, e);
        }
      });
      
      // Force override toolbox blocks
      forceToolboxUpdate(workspace, 'schema');
    }
    
    // Function to apply accessibility theme colors using research-backed palettes
    function applyAccessibilityThemeColors(workspace) {
      if (!workspace) return;
      
      const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
      console.log('Applying accessibility theme:', savedTheme);
      
      // Apply to workspace blocks
      const allBlocks = workspace.getAllBlocks();
      allBlocks.forEach(block => {
        try {
          // Map block types to the 8 accessibility categories with EXACT hex colors
          let blockColor = '#888888'; // default gray
          
          if (savedTheme === 'colorblind-wong') {
            // Wong palette
            if (block.type === 'start') {
              blockColor = '#000000'; // Black
            } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
              blockColor = '#e69f00'; // Orange
            } else if (['number', 'number_array'].includes(block.type)) {
              blockColor = '#56b4e9'; // Sky blue
            } else if (['boolean', 'boolean_array'].includes(block.type)) {
              blockColor = '#009e73'; // Blue green
            } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                     !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
              blockColor = '#f0e442'; // Yellow
            } else if (block.type.endsWith('_array')) {
              blockColor = '#0072b2'; // Blue
            } else if (block.type.endsWith('_dict')) {
              blockColor = '#d55e00'; // Vermillion
            } else if (['dictionary', 'dynarray'].includes(block.type)) {
              blockColor = '#cc79a7'; // Pale violet
            }
          } else if (savedTheme === 'colorblind-tol') {
            // Tol palette
            if (block.type === 'start') {
              blockColor = '#CC6677'; // Red
            } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
              blockColor = '#332288'; // Purple
            } else if (['number', 'number_array'].includes(block.type)) {
              blockColor = '#DDCC77'; // Yellow
            } else if (['boolean', 'boolean_array'].includes(block.type)) {
              blockColor = '#117733'; // Green
            } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                     !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
              blockColor = '#88CCEE'; // Light blue
            } else if (block.type.endsWith('_array')) {
              blockColor = '#882255'; // Magenta
            } else if (block.type.endsWith('_dict')) {
              blockColor = '#44AA99'; // Teal
            } else if (['dictionary', 'dynarray'].includes(block.type)) {
              blockColor = '#AA4499'; // Pink
            }
          }
          
          // Apply the color directly
          block.setColour(blockColor);
          console.log(`Applied ${savedTheme} color ${blockColor} to block ${block.type}`);
        } catch (e) {
          console.warn(`Failed to apply accessibility theme colors to block ${block.type}:`, e);
        }
      });
      
      // Force override toolbox blocks too
      forceToolboxUpdate(workspace, 'accessibility');
    }
    
    // Function to force toolbox update with correct colors
    function forceToolboxUpdate(workspace, mode) {
      if (!workspace || !workspace.getToolbox()) return;
      
      console.log('=== FORCING TOOLBOX UPDATE ===');
      
      try {
        // Force toolbox to re-render by closing and reopening
        const toolbox = workspace.getToolbox();
        const flyout = toolbox.getFlyout();
        
        if (flyout) {
          // Close the flyout
          flyout.hide();
          
          // Wait a moment then reopen to force re-render
          setTimeout(() => {
            // Reopen the flyout to force re-render with new colors
            const selectedCategory = toolbox.getSelectedItem();
            if (selectedCategory) {
              selectedCategory.showFlyout_();
            }
            
            // Wait for flyout to render, then update colors
            setTimeout(() => {
              if (flyout.getWorkspace()) {
                const flyoutBlocks = flyout.getWorkspace().getAllBlocks();
                console.log(`Found ${flyoutBlocks.length} flyout blocks to update`);
                
                flyoutBlocks.forEach(block => {
                  try {
                    let blockColor = 120; // default
                    
                    if (mode === 'accessibility') {
                      // Use research-backed accessibility colors with EXACT hex values
                      const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
                      
                      if (savedTheme === 'colorblind-wong') {
                        // Wong palette
                        if (block.type === 'start') {
                          blockColor = '#000000'; // Black
                        } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
                          blockColor = '#e69f00'; // Orange
                        } else if (['number', 'number_array'].includes(block.type)) {
                          blockColor = '#56b4e9'; // Sky blue
                        } else if (['boolean', 'boolean_array'].includes(block.type)) {
                          blockColor = '#009e73'; // Blue green
                        } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                                 !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
                          blockColor = '#f0e442'; // Yellow
                        } else if (block.type.endsWith('_array')) {
                          blockColor = '#0072b2'; // Blue
                        } else if (block.type.endsWith('_dict')) {
                          blockColor = '#d55e00'; // Vermillion
                        } else if (['dictionary', 'dynarray'].includes(block.type)) {
                          blockColor = '#cc79a7'; // Pale violet
                        }
                      } else if (savedTheme === 'colorblind-tol') {
                        // Tol palette
                        if (block.type === 'start') {
                          blockColor = '#CC6677'; // Red
                        } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
                          blockColor = '#332288'; // Purple
                        } else if (['number', 'number_array'].includes(block.type)) {
                          blockColor = '#DDCC77'; // Yellow
                        } else if (['boolean', 'boolean_array'].includes(block.type)) {
                          blockColor = '#117733'; // Green
                        } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                                 !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
                          blockColor = '#88CCEE'; // Light blue
                        } else if (block.type.endsWith('_array')) {
                          blockColor = '#882255'; // Magenta
                        } else if (block.type.endsWith('_dict')) {
                          blockColor = '#44AA99'; // Teal
                        } else if (['dictionary', 'dynarray'].includes(block.type)) {
                          blockColor = '#AA4499'; // Pink
                        }
                      }
                    } else {
                      // Use schema colors from S3BlockLoader
                      let schemaLibrary = {};
                      if (window.currentS3BlockLoader && window.currentS3BlockLoader.schemaLibrary) {
                        schemaLibrary = window.currentS3BlockLoader.schemaLibrary;
                      }
                      
                      let baseBlockName = block.type;
                      if (baseBlockName.endsWith('_array') || baseBlockName.endsWith('_dict')) {
                        baseBlockName = baseBlockName.replace(/_array$|_dict$/, '');
                      }
                      
                      if (schemaLibrary[baseBlockName] && schemaLibrary[baseBlockName].color !== undefined) {
                        blockColor = schemaLibrary[baseBlockName].color;
                        console.log(`âœ“ Applied schema color ${blockColor} to toolbox block ${block.type} (${baseBlockName})`);
                      } else {
                        const defaultColors = {
                          'start': 250,
                          'dictionary': 120,
                          'dynarray': 120,
                          'boolean': 155,
                          'boolean_array': 155,
                          'string': 190,
                          'string_password': 190,
                          'string_email': 190,
                          'string_enum': 190,
                          'string_array': 190,
                          'number': 210,
                          'number_array': 210
                        };
                        blockColor = defaultColors[block.type] || 120;
                        console.log(`âœ“ Applied default color ${blockColor} to toolbox block ${block.type}`);
                      }
                    }
                    
                    block.setColour(blockColor);
                  } catch (e) {
                    console.warn(`Failed to apply color to toolbox block ${block.type}:`, e);
                  }
                });
              }
            }, 200); // Wait longer for flyout to fully render
          }, 100);
        }
      } catch (e) {
        console.warn('Failed to force toolbox update:', e);
      }
    }
    
    
    // Function to apply accessibility theme colors
    function applyAccessibilityColors(workspace, theme) {
      if (!workspace) return;
      
      const allBlocks = workspace.getAllBlocks();
      allBlocks.forEach(block => {
        // Store original color if not already stored
        if (block._originalColor === undefined) {
          try {
            // Get current color before applying theme
            const currentColor = block.getColour();
            if (currentColor !== undefined) {
              block._originalColor = currentColor;
            }
          } catch (e) {
            console.warn(`Failed to store original color for block ${block.type}:`, e);
          }
        }
      });
    }
    
    function changeTheme() {
      const themeSelect = document.getElementById('themeSelect');
      const selectedTheme = themeSelect.value;
      
      console.log('=== CHANGE THEME CALLED ===');
      console.log('Selected theme:', selectedTheme);
      
      if (currentWorkspace && themes[selectedTheme]) {
        // Check if this is an accessibility theme
        const isAccessibilityTheme = ['colorblind-wong', 'colorblind-tol'].includes(selectedTheme);
        
        console.log('Is accessibility theme:', isAccessibilityTheme);
        
        // Save theme to localStorage FIRST
        localStorage.setItem('blockly-theme', selectedTheme);
        
        // Apply Blockly theme first
        currentWorkspace.setTheme(themes[selectedTheme]);
        
        // Then override ALL block colors directly
        if (isAccessibilityTheme) {
          // For accessibility themes, apply 8-color palette
          console.log('Calling applyAccessibilityThemeColors from changeTheme');
          applyAccessibilityThemeColors(currentWorkspace);
        } else {
          // For normal themes, restore original schema colors
          console.log('Calling restoreOriginalColors from changeTheme');
          restoreOriginalColors(currentWorkspace);
        }
        
        // Change UI background based on theme
        const root = document.documentElement;
        const body = document.body;
        
        // Remove all theme classes first
        body.classList.remove('classic-theme', 'modern-theme', 'dark-theme');
        
        if (selectedTheme === 'classic') {
          // Classic theme: white background
          root.style.setProperty('--bg-color', '#ffffff');
          root.style.setProperty('--text-color', '#000000');
          root.style.setProperty('--blockly-bg', '#fafafa');
          root.style.setProperty('--controls-bg', '#ffffff');
          root.style.setProperty('--border-color', '#e0e0e0');
          body.classList.add('classic-theme');
        } else if (selectedTheme === 'modern') {
          // Modern theme: light background
          root.style.setProperty('--bg-color', '#ffffff');
          root.style.setProperty('--text-color', '#000000');
          root.style.setProperty('--blockly-bg', '#fafafa');
          root.style.setProperty('--controls-bg', '#ffffff');
          root.style.setProperty('--border-color', '#e0e0e0');
          body.classList.add('modern-theme');
        } else {
          // Dark themes: keep dark UI background
          root.style.setProperty('--bg-color', '#1e1e1e');
          root.style.setProperty('--text-color', '#ffffff');
          root.style.setProperty('--blockly-bg', '#1e1e1e');
          root.style.setProperty('--controls-bg', '#2d2d30');
          root.style.setProperty('--border-color', '#444');
          body.classList.add('dark-theme');
        }
        
        // Theme preference already saved above
      }
    }
    
    // Load saved theme preference
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
      const themeSelect = document.getElementById('themeSelect');
      themeSelect.value = savedTheme;
      
      // Apply UI background changes immediately
      const root = document.documentElement;
      const body = document.body;
      
      // Remove all theme classes first
      body.classList.remove('classic-theme', 'modern-theme', 'dark-theme');
      
      if (savedTheme === 'classic') {
        // Classic theme: white background
        root.style.setProperty('--bg-color', '#ffffff');
        root.style.setProperty('--text-color', '#000000');
        root.style.setProperty('--blockly-bg', '#fafafa');
        root.style.setProperty('--controls-bg', '#ffffff');
        root.style.setProperty('--border-color', '#e0e0e0');
        body.classList.add('classic-theme');
      } else if (savedTheme === 'modern') {
        // Modern theme: light background
        root.style.setProperty('--bg-color', '#ffffff');
        root.style.setProperty('--text-color', '#000000');
        root.style.setProperty('--blockly-bg', '#fafafa');
        root.style.setProperty('--controls-bg', '#ffffff');
        root.style.setProperty('--border-color', '#e0e0e0');
        body.classList.add('modern-theme');
      } else {
        // Dark themes: keep dark UI background
        root.style.setProperty('--bg-color', '#1e1e1e');
        root.style.setProperty('--text-color', '#ffffff');
        root.style.setProperty('--blockly-bg', '#1e1e1e');
        root.style.setProperty('--controls-bg', '#2d2d30');
        root.style.setProperty('--border-color', '#444');
        body.classList.add('dark-theme');
      }
      
      // Apply theme to workspace if available
      if (currentWorkspace && themes[savedTheme]) {
        // Check if this is an accessibility theme
        const isAccessibilityTheme = ['colorblind-wong', 'colorblind-tol'].includes(savedTheme);
        
        // Apply Blockly theme first
        currentWorkspace.setTheme(themes[savedTheme]);
        
        // Then override ALL block colors directly
        if (isAccessibilityTheme) {
          // For accessibility themes, apply 8-color palette
          applyAccessibilityThemeColors(currentWorkspace);
        } else {
          // For normal themes, restore original schema colors
          restoreOriginalColors(currentWorkspace);
        }
      }
    }
    
    // Function to get workspace reference and apply theme
    function applyThemeToWorkspace() {
      if (typeof Blockly !== 'undefined' && Blockly.getMainWorkspace) {
        currentWorkspace = Blockly.getMainWorkspace();
        window.currentWorkspace = currentWorkspace;
        
        // Apply saved theme
        loadThemePreference();
        
        // Add change listener to apply theme to new blocks
        currentWorkspace.addChangeListener((event) => {
          if (event.type === Blockly.Events.BLOCK_CREATE || event.type === Blockly.Events.BLOCK_CHANGE) {
            // Apply current theme to new/changed blocks
            const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
            const isAccessibilityTheme = ['colorblind-wong', 'colorblind-tol'].includes(savedTheme);
            
            console.log('Change listener triggered - savedTheme:', savedTheme, 'isAccessibilityTheme:', isAccessibilityTheme);
            
            // Apply theme colors to new blocks
            if (isAccessibilityTheme) {
              console.log('Calling applyAccessibilityThemeColors from change listener');
              applyAccessibilityThemeColors(currentWorkspace);
            } else {
              console.log('Calling restoreOriginalColors from change listener');
              restoreOriginalColors(currentWorkspace);
            }
          }
        });
        
        // Add variable block listener to update newly created variable blocks
        if (window.addVariableBlockListener) {
          window.addVariableBlockListener(currentWorkspace);
        }
      } else {
        // Retry after a short delay if workspace isn't ready yet
        setTimeout(applyThemeToWorkspace, 100);
      }
    }
    
    // Load theme preference immediately when page loads (after themes are defined)
    loadThemePreference();
    
    // Override the S3BlockLoader initializeBlockly method to store workspace reference
    const originalInitializeBlockly = S3BlockLoader.prototype.initializeBlockly;
    S3BlockLoader.prototype.initializeBlockly = function() {
      // Call the original method
      const result = originalInitializeBlockly.call(this);
      
      // Store the workspace reference
      if (typeof Blockly !== 'undefined' && Blockly.getMainWorkspace) {
        currentWorkspace = Blockly.getMainWorkspace();
        window.currentWorkspace = currentWorkspace;
        
        // Apply saved theme
        loadThemePreference();
      }
      
      return result;
    };
    
    // Override the workspace initialization to store reference and apply theme
    const originalInitialize = window.initialize;
    window.initialize = function() {
      if (originalInitialize) {
        originalInitialize();
      }
      
      // Apply theme after workspace is initialized
      setTimeout(applyThemeToWorkspace, 200);
    };
    
    // Blockly initialization is now handled by dynamic-blocks.js
    // This ensures blocks are loaded based on tenant schemas before initialization
  </script>
</body>
</html>

